import {tmpdir} from "node:os"
import {cwd} from "node:process"
import {eleventyClean} from "@onlyoffice/eleventy-clean"
import {isBuild} from "@onlyoffice/eleventy-env"
import {eleventyHtmlMinifierTerser} from "@onlyoffice/eleventy-html-minifier-terser"
import {eleventyPagefind} from "@onlyoffice/eleventy-pagefind"
import {eleventySitemap} from "@onlyoffice/eleventy-sitemap"
import {eleventyStarryNight} from "@onlyoffice/eleventy-starry-night"
import {type UserConfig} from "@onlyoffice/eleventy-types"
import {configMode} from "@onlyoffice/site-env"
import {Config} from "@onlyoffice/site-config"
import esbuild from "esbuild"
import requireFromString from "require-from-string"
import {eleventyMarkdown} from "./internal/markdown.tsx"

function config(uc: UserConfig): unknown {
  Config.shared = Config.read(cwd(), configMode())

  uc.addPlugin(eleventyClean)

  // https://github.com/11ty/eleventy/issues/235
  uc.addTemplateFormats("11ty.js")
  uc.addExtension("tsx", {key: "11ty.js"})

  // https://github.com/11ty/eleventy/issues/577#issuecomment-2145656296
  uc.setDataFileSuffixes([".data"])
  uc.addDataExtension("ts", {
    async parser(_, f) {
      const r = await esbuild.build({
        entryPoints: [f],
        format: "cjs",
        outdir: tmpdir(),
        write: false,
      })
      const m = requireFromString(r.outputFiles[0].text)
      return m.data()
    },
  })

  uc.addPlugin(eleventyMarkdown)

  uc.addPlugin(eleventyHtmlMinifierTerser, {
    minify: isBuild(),
    collapseBooleanAttributes: true,
    collapseWhitespace: true,
    decodeEntities: true,
    includeAutoGeneratedTags: false,
    removeAttributeQuotes: true,
    removeComments: true,
    removeEmptyAttributes: true,
    sortAttributes: true,
  })

  uc.addPlugin(eleventyStarryNight)
  uc.addPlugin(eleventySitemap)
  uc.addPlugin(eleventyPagefind)

  uc.addPassthroughCopy({static: "."})

  return {
    dir: {
      data: "data",
      includes: "../components",
      input: "pages",
      layouts: "../layouts",
      output: "dist"
    }
  }
}

// Eleventy does not understand the default export.
// eslint-disable-next-line unicorn/prefer-module
module.exports = config
