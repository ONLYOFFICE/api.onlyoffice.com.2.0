// @ts-check

/**
 * @typedef {import("@11ty/eleventy").UserConfig} UserConfig
 */

const minifier = require("html-minifier-terser")
const { isBuild } = require("./any.js")

/**
 * @param {UserConfig} c
 * @returns {void}
 */
function plugin(c) {
  if (!isBuild()) {
    return
  }
  c.addTransform("minify-html", minifyHTML)
}

/**
 * @this any
 * @param {string} c
 * @returns {Promise<string | undefined>}
 */
async function minifyHTML(c) {
  if (this.outputPath === false) {
    return
  }
  if (!this.outputPath.endsWith(".html")) {
    return c
  }
  return minifier.minify(c, {
    collapseBooleanAttributes: true,
    collapseWhitespace: true,
    decodeEntities: true,
    includeAutoGeneratedTags: false,
    removeAttributeQuotes: true,
    removeComments: true,
    removeEmptyAttributes: true,
    removeRedundantAttributes: true,
    sortAttributes: true
  })
}

module.exports = { plugin }
