// @ts-check

/**
 * @typedef {import("@11ty/eleventy").UserConfig} UserConfig
 */

const { minify } = require("html-minifier-terser")
const pack = require("../package.json")

/**
 * @typedef {object} Options
 * @property {boolean} minify
 */

/**
 * @param {UserConfig} uc
 * @param {Options} o
 * @returns {void}
 */
function html(uc, o) {
  if (o.minify !== true) {
    return
  }
  uc.addTransform(`${pack.name}/minify-html`, function minifyHTML(c) {
    if (this.outputPath === false) {
      return
    }
    if (!this.outputPath.endsWith(".html")) {
      return c
    }
    return minify(c, {
      collapseBooleanAttributes: true,
      collapseWhitespace: true,
      decodeEntities: true,
      includeAutoGeneratedTags: false,
      removeAttributeQuotes: true,
      removeComments: true,
      removeEmptyAttributes: true,
      removeRedundantAttributes: true,
      sortAttributes: true
    })
  })
}

module.exports = { html }
